<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>MacroCalc</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background-color:#121212; color:#eee; }
.container { max-width:800px; margin:auto; padding:20px; }
h1 { text-align:center; margin-bottom:20px; }

/* Menú */
nav { display:flex; justify-content:center; gap:20px; margin-bottom:20px; flex-wrap:wrap; }
nav button { background-color:#1f1f1f; border:none; padding:10px 20px; border-radius:10px; cursor:pointer; color:#eee; font-weight:bold; transition:0.2s; }
nav button:hover { background-color:#333; }

/* Secciones */
section { display:none; }
section.active { display:block; }

/* Formulario añadir comida */
.form-group { margin-bottom:15px; }
.form-group label { display:block; margin-bottom:5px; font-weight:bold; }
.form-group input, .form-group select, .form-group textarea { width:100%; padding:8px; border-radius:5px; border:none; }
button.save { background-color:#4caf50; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold; transition:0.2s; }
button.save:hover { background-color:#45a049; }

/* Calendario */
#calendario { text-align:center; }
#yearSelector { margin-bottom:10px; padding:5px; border-radius:5px; border:none; background:#2a2a2a; color:#eee; }
.month { margin-bottom:20px; }
.month h3 { margin-bottom:10px; text-transform: capitalize; }
.dia { display:inline-block; width:40px; height:40px; line-height:40px; margin:2px; border-radius:50%; background:#2a2a2a; cursor:pointer; transition:0.2s; }
.dia.cumplido { background-color:#4caf50; }
.dia.nocumplido { background-color:#e74c3c; }
.dia:hover { transform:scale(1.2); }

/* Detalle día */
#detalle_dia { margin-top:20px; text-align:left; }

/* Subir foto/audio */
input[type=file] { background-color:#2a2a2a; color:#eee; padding:8px; border-radius:5px; border:none; }
textarea { resize:none; }

/* Lista comidas hoy */
#resumen_hoy { margin-top:15px; }

/* Botones editar/borrar */
button.edit, button.delete { margin-left:5px; padding:2px 6px; font-size:12px; border:none; border-radius:5px; cursor:pointer; }
button.edit { background:#3498db; color:white; }
button.delete { background:#e74c3c; color:white; }

/* Botón configurar macros */
#config_macros { background:#9b59b6; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; margin-bottom:10px; }
#panel_macros { display:none; margin-bottom:20px; }

/* Responsive */
@media(max-width:500px){
  .dia { width:30px; height:30px; line-height:30px; font-size:12px; }
  nav button { width:80%; margin:auto; margin-bottom:10px; }
}
</style>
</head>
<body>
<div class="container">
<h1>MacroCalc</h1>

<nav>
  <button onclick="abrirSeccion('añadir')">Añadir Comida</button>
  <button onclick="abrirSeccion('calendario')">Calendario</button>
</nav>

<!-- Añadir Comida -->
<section id="añadir">
  <div class="form-group">
    <label>Fecha:</label>
    <input type="date" id="fecha_comida">
  </div>

  <div class="form-group">
    <label>Comida:</label>
    <select id="tipo_comida">
      <option value="desayuno">Desayuno</option>
      <option value="comida">Comida</option>
      <option value="merienda">Merienda</option>
      <option value="cena">Cena</option>
    </select>
  </div>

  <div class="form-group">
    <label>Notas:</label>
    <textarea id="texto_comida" rows="3" placeholder="Describe tu comida..."></textarea>
  </div>

  <div class="form-group">
    <input type="file" id="foto_comida" accept="image/*">
  </div>

  <div class="form-group">
    <input type="file" id="audio_comida" accept="audio/*">
  </div>

  <button class="save" onclick="guardarComida()">💾 Guardar Comida</button>

  <div id="resumen_hoy"></div>
</section>

<!-- Calendario -->
<section id="calendario">
  <select id="yearSelector" onchange="mostrarCalendario()"></select>
  <button id="config_macros" onclick="toggleMacros()">⚙️ Configurar macros</button>
  <div id="panel_macros">
    Proteínas: <input type="number" id="objetivo_prote" value="150"> 
    Grasas: <input type="number" id="objetivo_gras" value="50"> 
    Carbs: <input type="number" id="objetivo_carbs" value="300">
    Kcal: <input type="number" id="objetivo_kcal" value="2200">
    <button class="save" onclick="guardarObjetivo()">💾 Guardar objetivo</button>
  </div>
  <div id="meses"></div>
  <div id="detalle_dia"></div>
</section>

</div>

<script>
// Secciones
function abrirSeccion(id){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// LocalStorage
function cargarDatos(){ return JSON.parse(localStorage.getItem('diario'))||{}; }
function guardarDatos(datos){ localStorage.setItem('diario',JSON.stringify(datos)); }

// Detectar comida según hora
function detectarComida(){
  const h = new Date().getHours();
  if(h>=6 && h<11) return 'desayuno';
  if(h>=11 && h<16) return 'comida';
  if(h>=16 && h<19) return 'merienda';
  return 'cena';
}

// Inicializar añadir comida
const fechaInput=document.getElementById('fecha_comida');
fechaInput.value=new Date().toISOString().substr(0,10);
document.getElementById('tipo_comida').value=detectarComida();

// Guardar comida
function guardarComida(){
  const fecha=fechaInput.value;
  const tipo=document.getElementById('tipo_comida').value;
  const texto=document.getElementById('texto_comida').value;

  // TODO: foto/audio en base64
  const comida={texto, macros:{proteinas:20, grasas:15, carbs:30, kcal:350}};

  const datos=cargarDatos();
  if(!datos[fecha]) datos[fecha]={};
  if(!datos[fecha][tipo]) datos[fecha][tipo]=[];
  datos[fecha][tipo].push(comida);
  guardarDatos(datos);
  alert("Comida guardada!");
  mostrarCalendario();
  mostrarResumenHoy();
}

// Guardar objetivo
function guardarObjetivo(){
  const datos=cargarDatos();
  datos.objetivo={
    proteinas:Number(document.getElementById('objetivo_prote').value),
    grasas:Number(document.getElementById('objetivo_gras').value),
    carbs:Number(document.getElementById('objetivo_carbs').value),
    kcal:Number(document.getElementById('objetivo_kcal').value)
  };
  guardarDatos(datos);
  mostrarCalendario();
  toggleMacros();
}

// Toggle panel macros
function toggleMacros(){
  const panel=document.getElementById('panel_macros');
  panel.style.display=(panel.style.display==='none')?'block':'none';
}

// Mostrar calendario anual con selector de año
function mostrarCalendario(){
  const datos=cargarDatos();
  const mesesDiv=document.getElementById('meses');
  mesesDiv.innerHTML='';

  const year=document.getElementById('yearSelector').value || new Date().getFullYear();
  for(let m=0; m<12; m++){
    const mes=new Date(year, m,1);
    const nombreMes=mes.toLocaleString('es',{month:'long'});
    const days=new Date(mes.getFullYear(), mes.getMonth()+1,0).getDate();

    const mesDiv=document.createElement('div');
    mesDiv.className='month';
    mesDiv.innerHTML=`<h3>${nombreMes} ${mes.getFullYear()}</h3>`;
    for(let d=1; d<=days; d++){
      const fecha=`${mes.getFullYear()}-${String(mes.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const div=document.createElement('div');
      div.className='dia';
      div.textContent=d;
      if(datos[fecha]){
        const objetivo=datos.objetivo||{proteinas:0,grasas:0,carbs:0,kcal:0};
        let tot={proteinas:0,grasas:0,carbs:0,kcal:0};
        for(let tipo in datos[fecha]){
          datos[fecha][tipo].forEach(c=>{
            tot.proteinas+=c.macros.proteinas;
            tot.grasas+=c.macros.grasas;
            tot.carbs+=c.macros.carbs;
            tot.kcal+=c.macros.kcal;
          });
        }
        if(tot.proteinas>=objetivo.proteinas &&
           tot.grasas>=objetivo.grasas &&
           tot.carbs>=objetivo.carbs &&
           tot.kcal>=objetivo.kcal){
          div.classList.add('cumplido');
        }else div.classList.add('nocumplido');
      }else div.classList.add('nocumplido');
      div.onclick=()=> mostrarDetalleDia(fecha);
      mesDiv.appendChild(div);
    }
    mesesDiv.appendChild(mesDiv);
  }
}

// Detalle día
function mostrarDetalleDia(fecha){
  const datos=cargarDatos();
  const detalle=document.getElementById('detalle_dia');
  if(!datos[fecha]) { detalle.innerHTML="Sin datos"; return; }
  let html=`<h3>Detalles ${fecha}</h3>`;
  for(let tipo in datos[fecha]){
    html+=`<b>${tipo}</b><ul>`;
    datos[fecha][tipo].forEach((c,i)=>{
      html+=`<li>${c.texto} (P:${c.macros.proteinas} G:${c.macros.grasas} C:${c.macros.carbs} Kcal:${c.macros.kcal})
        <button class="edit" onclick="editarComida('${fecha}','${tipo}',${i})">Editar</button>
        <button class="delete" onclick="borrarComida('${fecha}','${tipo}',${i})">Borrar</button>
      </li>`;
    });
    html+=`</ul>`;
  }
  detalle.innerHTML=html;
}

// Editar/Borrar comida
function editarComida(fecha,tipo,index){
  const datos=cargarDatos();
  const comida=datos[fecha][tipo][index];
  fechaInput.value=fecha;
  document.getElementById('tipo_comida').value=tipo;
  document.getElementById('texto_comida').value=comida.texto;
  datos[fecha][tipo].splice(index,1);
  guardarDatos(datos);
  mostrarResumenHoy();
  mostrarCalendario();
}

function borrarComida(fecha,tipo,index){
  const datos=cargarDatos();
  if(confirm("¿Borrar esta comida?")){
    datos[fecha][tipo].splice(index,1);
    guardarDatos(datos);
    mostrarDetalleDia(fecha);
    mostrarResumenHoy();
    mostrarCalendario();
  }
}

// Mostrar resumen hoy
function mostrarResumenHoy(){
  const datos=cargarDatos();
  const hoy=new Date().toISOString().substr(0,10);
  const resumen=document.getElementById('resumen_hoy');
  resumen.innerHTML='';
  if(!datos[hoy]) return;
  for(let tipo of ['desayuno','comida','merienda','cena']){
    if(datos[hoy][tipo]){
      let html=`<b>${tipo}</b><ul>`;
      datos[hoy][tipo].forEach((c,i)=> html+=`<li>${c.texto} (P:${c.macros.proteinas} G:${c.macros.grasas} C:${c.macros.carbs} Kcal:${c.macros.kcal}) 
        <button class="edit" onclick="editarComida('${hoy}','${tipo}',${i})">Editar</button>
        <button class="delete" onclick="borrarComida('${hoy}','${tipo}',${i})">Borrar</button></li>`);
      html+='</ul>';
      resumen.innerHTML+=html;
    }
  }
}

// Inicializar selector de año
const yearSel=document.getElementById('yearSelector');
const currentYear=new Date().getFullYear();
for(let y=currentYear-5; y<=currentYear+1; y++){
  const opt=document.createElement('option');
  opt.value=y; opt.textContent=y;
  if(y===currentYear) opt.selected=true;
  yearSel.appendChild(opt);
}

mostrarCalendario();
abrirSeccion('añadir');
mostrarResumenHoy();
</script>
</body>
</html>
